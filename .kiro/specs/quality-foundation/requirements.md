# 要件定義書

## はじめに

このドキュメントは、FIREシミュレーターWebアプリケーションの品質基盤を整備するための要件を定義します。現在、アプリケーションには自動テストが存在せず、エラーハンドリングも不十分です。本プロジェクトでは、重要な計算ロジックのテストカバレッジを確保し、基本的なエラーハンドリングを実装することで、今後の機能追加を安全に行える基盤を構築します。

## 用語集

- **システム**: FIREシミュレーターWebアプリケーション
- **計算モジュール**: `src/utils/calculations.ts`に定義された計算関数群
- **FIRE目標額**: 経済的自立に必要な資産額（年間支出 ÷ 引き出し率）
- **モンテカルロシミュレーション**: 確率的シミュレーション手法。投資リターンの不確実性を考慮した資産推移予測
- **プロパティベーステスト**: 任意の入力に対して成立すべき性質を検証するテスト手法
- **ユニットテスト**: 個別の関数やメソッドの動作を検証するテスト
- **テストフレームワーク**: テストを実行するためのライブラリ（Vitest）
- **アサーションライブラリ**: テスト結果を検証するためのライブラリ
- **エッジケース**: 境界値や特殊な入力条件

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、プロジェクトにテストフレームワークを設定したい。そうすれば、自動テストを書いて実行できる。

#### 受入基準

1. WHEN テストコマンドが実行される THEN システム SHALL すべてのテストファイルを実行し結果を表示する
2. WHEN `.test.ts`拡張子のテストファイルが作成される THEN システム SHALL 自動的にそれを発見し実行する
3. WHEN テストが実行される THEN システム SHALL 合格/不合格のステータスと実行時間を報告する
4. WHEN テストが失敗する THEN システム SHALL スタックトレース付きの明確なエラーメッセージを表示する

### 要件2

**ユーザーストーリー:** 開発者として、FIRE目標額計算のユニットテストを書きたい。そうすれば、コアとなる金融計算が正しいことを保証できる。

#### 受入基準

1. WHEN 年間支出が300万円で引き出し率が4% THEN 計算モジュール SHALL FIRE目標額として7500万円を返す
2. WHEN 引き出し率が0または負の値 THEN 計算モジュール SHALL FIRE目標額として0を返す
3. WHEN 年間支出が0 THEN 計算モジュール SHALL FIRE目標額として0を返す
4. WHEN 引き出し率が3% THEN 計算モジュール SHALL 式(支出 / (率 / 100))を使用してFIRE目標額を計算する

### 要件3

**ユーザーストーリー:** 開発者として、FIRE目標額計算のプロパティベーステストを書きたい。そうすれば、幅広い入力範囲で計算が正しく動作することを検証できる。

#### 受入基準

1. WHEN 任意の正の年間支出と正の引き出し率が提供される THEN FIRE目標額 SHALL 常に正の値である
2. WHEN 引き出し率が2倍になる THEN FIRE目標額 SHALL 半分になる
3. WHEN 年間支出が2倍になる THEN FIRE目標額 SHALL 2倍になる
4. WHEN FIRE目標額に(引き出し率 / 100)を掛ける THEN 結果 SHALL 年間支出と等しくなる

### 要件4

**ユーザーストーリー:** 開発者として、FIRE達成年数計算のユニットテストを書きたい。そうすれば、退職時期の予測が正確であることを保証できる。

#### 受入基準

1. WHEN 現在資産がFIRE目標額以上 THEN 計算モジュール SHALL 0年を返す
2. WHEN 年間貯蓄が0または負で運用利回りが0 THEN 計算モジュール SHALL nullを返す
3. WHEN 現在資産が1000万円、年間貯蓄が200万円、運用利回りが5%、FIRE目標額が5000万円 THEN 計算モジュール SHALL 目標達成まで反復的に年数を計算する
4. WHEN 計算が100年を超える THEN 計算モジュール SHALL nullを返す

### 要件5

**ユーザーストーリー:** 開発者として、FIRE達成年数計算のプロパティベーステストを書きたい。そうすれば、様々なシナリオで計算が正しく動作することを検証できる。

#### 受入基準

1. WHEN 現在資産がFIRE目標額以上 THEN FIRE達成年数 SHALL 0である
2. WHEN 年間貯蓄が正で運用利回りが非負 THEN FIRE達成年数 SHALL 非負の数またはnullである
3. WHEN 年間貯蓄が増加する THEN FIRE達成年数 SHALL 減少するか同じである
4. WHEN 運用利回りが増加する THEN FIRE達成年数 SHALL 減少するか同じである

### 要件6

**ユーザーストーリー:** 開発者として、資産推移シミュレーションのユニットテストを書きたい。そうすれば、長期予測が正しく計算されることを保証できる。

#### 受入基準

1. WHEN シミュレーションが開始される THEN システム SHALL 現在年齢から100歳までのデータポイントを生成する
2. WHEN 年齢が退職年齢未満 THEN シミュレーションデータ SHALL isRetiredをfalseとしてマークする
3. WHEN 年齢が退職年齢以上 THEN シミュレーションデータ SHALL isRetiredをtrueとしてマークする
4. WHEN NISAが使用されない THEN システム SHALL 投資リターンに税率を適用する
5. WHEN 資産が0に達する THEN システム SHALL その後の年も資産を0に維持する

### 要件7

**ユーザーストーリー:** 開発者として、資産推移シミュレーションのプロパティベーステストを書きたい。そうすれば、異なる入力の組み合わせでシミュレーションの不変条件が保たれることを検証できる。

#### 受入基準

1. WHEN シミュレーションが実行される THEN データポイント数 SHALL (100 - 現在年齢 + 1)と等しい
2. WHEN すべての年で支出が収入を超える THEN 資産 SHALL 単調減少するか0に留まる
3. WHEN すべての年で収入が支出を超え運用利回りが正 THEN 資産 SHALL 単調増加する
4. WHEN インフレ率が0 THEN 支出 SHALL すべての年で一定である

### 要件8

**ユーザーストーリー:** 開発者として、モンテカルロシミュレーションのユニットテストを書きたい。そうすれば、確率的予測が統計的に健全であることを保証できる。

#### 受入基準

1. WHEN モンテカルロシミュレーションが実行される THEN システム SHALL 現在年齢から100歳までの各年齢の結果を生成する
2. WHEN モンテカルロシミュレーションが実行される THEN すべての年齢でpercentile10 SHALL percentile50以下である
3. WHEN モンテカルロシミュレーションが実行される THEN すべての年齢でpercentile50 SHALL percentile90以下である
4. WHEN ボラティリティが0 THEN すべてのパーセンタイル SHALL 類似した値に収束する

### 要件9

**ユーザーストーリー:** 開発者として、モンテカルロシミュレーションのプロパティベーステストを書きたい。そうすれば、異なるパラメータで統計的性質が保たれることを検証できる。

#### 受入基準

1. WHEN 任意の有効な入力でモンテカルロシミュレーションが実行される THEN percentile10 SHALL 常にpercentile90以下である
2. WHEN ボラティリティが増加する THEN percentile10とpercentile90の差 SHALL 増加する
3. WHEN 反復回数が増加する THEN 結果 SHALL 統計的に一貫性を保つ
4. WHEN 同じ入力が複数回提供される THEN 中央値の結果 SHALL 統計的分散の範囲内で類似する

### 要件10

**ユーザーストーリー:** 開発者として、計算関数の入力検証を実装したい。そうすれば、無効な入力が適切に処理される。

#### 受入基準

1. WHEN 年齢、資産、収入、支出に負の値が提供される THEN システム SHALL クラッシュせずに処理する
2. WHEN 数値でない値が提供される THEN システム SHALL 明確なエラーで入力を拒否する
3. WHEN 退職年齢が現在年齢より小さい THEN システム SHALL シナリオを適切に処理する
4. WHEN 極端に大きな数値が提供される THEN システム SHALL オーバーフローエラーなしで計算を処理する

### 要件11

**ユーザーストーリー:** 開発者として、localStorage操作のエラーハンドリングを実装したい。そうすれば、データ永続化の失敗でアプリケーションがクラッシュしない。

#### 受入基準

1. WHEN localStorageが利用できない THEN システム SHALL デフォルト値にフォールバックする
2. WHEN localStorageに破損したデータが含まれる THEN システム SHALL デフォルト値にフォールバックしエラーをログに記録する
3. WHEN localStorageのクォータを超える THEN システム SHALL エラーを適切に処理する
4. WHEN localStorageからの読み取りが失敗する THEN システム SHALL アプリケーションの読み込みを妨げない

### 要件12

**ユーザーストーリー:** ユーザーとして、計算が失敗したときに明確なエラーメッセージを見たい。そうすれば、何が問題だったのか理解できる。

#### 受入基準

1. WHEN 計算エラーが発生する THEN システム SHALL ユーザーフレンドリーなエラーメッセージを表示する
2. WHEN 無効な入力が検出される THEN システム SHALL 問題のあるフィールドをハイライトする
3. WHEN エラーメッセージが表示される THEN システム SHALL 問題の修正方法のガイダンスを提供する
4. WHEN エラーが回復される THEN システム SHALL エラーメッセージを自動的にクリアする
